<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attempt Verifier Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- NEW: Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        :root {
            --bg: #0f172a;
            --bg-alt: #020617;
            --card: #111827;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.1);
            --danger: #f97373;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f2933;
            --success: #4ade80;
            --warning: #facc15;
            --flagged: #f97316;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #020617 100%);
            color: var(--text);
        }

        .page { max-width: 1080px; margin: 0 auto; padding: 24px 16px 40px; }

        /* ... (your existing styles unchanged)... */

        /* NEW: Map modal */
        #mapModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        #mapPanel {
            width: 90%;
            height: 85%;
            background: #0b1120;
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        #mapContainer {
            flex: 1;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            padding: 8px 4px;
            color: var(--muted);
        }

        .btn-close {
            background: var(--danger);
            padding: 4px 10px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
<div class="page">

    <!-- HEADER -->
    <header>
        <div class="tagline">
            <div class="tagline-dot"></div>
            <span>Attempt Verifier · Java Spring Boot</span>
        </div>
        <h1>Trail GPX Attempt Verifier</h1>
        <p>Upload a GPX track and compare it with the official route.</p>
    </header>

    <!-- MAIN GRID -->
    <main>

        <!-- UPLOAD FORM (unchanged) -->
        <section class="card">
            <!-- ... unchanged ... -->
        </section>

        <!-- ATTEMPTS LOG -->
        <section class="card">
            <div class="card-header">
                <div>
                    <h2>Attempts Log</h2>
                    <span id="attemptCount" class="badge-small">0 attempts</span>
                </div>

                <div class="filters-row">
                    <input id="filterRunner" type="text" placeholder="Filter runner…">
                    <select id="filterResult">
                        <option value="">All</option>
                        <option value="VERIFIED">Verified</option>
                        <option value="FLAGGED">Flagged</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
            </div>

            <div style="max-height:360px; overflow:auto; border:1px solid #0b1120; border-radius:12px;">
                <table>
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>Runner</th>
                        <th>Dist</th>
                        <th>Gain</th>
                        <th>Coverage</th>
                        <th>Dev (m)</th>
                        <th>Score</th>
                        <th>Result</th>
                        <th>Message</th>
                        <th>ID</th>
                        <!-- NEW -->
                        <th>Map</th>
                    </tr>
                    </thead>
                    <tbody id="attemptsBody"></tbody>
                </table>
            </div>
        </section>

    </main>
</div>

<!-- NEW: MAP MODAL -->
<div id="mapModal">
    <div id="mapPanel">
        <div class="map-header">
            <span id="mapTitle">GPX Viewer</span>
            <div class="btn-close" onclick="closeMap()">Close</div>
        </div>
        <div id="mapContainer"></div>
    </div>
</div>

<!-- NEW: Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let allAttempts = [];
    const attemptsBody = document.getElementById("attemptsBody");
    const attemptCount = document.getElementById("attemptCount");

    function formatNumber(v,d){ return v==null? "" : Number(v).toFixed(d); }

    function formatBadge(r){
        r = (r||"").toUpperCase();
        let cls =
            r==="VERIFIED"?"result-verified":
            r==="FLAGGED" ?"result-flagged":
            "result-rejected";
        return `<span class="result-badge ${cls}"><span></span>${r}</span>`;
    }

    // ---------------------------------------------------------------
    // RENDER TABLE
    // ---------------------------------------------------------------
    function renderAttempts(list){
        attemptsBody.innerHTML="";
        if(!list||list.length===0){
            attemptCount.textContent="0 attempts";
            return;
        }
        attemptCount.textContent=`${list.length} attempts`;

        attemptsBody.innerHTML = list.map(a=>{
            let pct = a.coverageRatio!=null ? (a.coverageRatio*100) : null;

            const cls =
                a.result==="VERIFIED"?"row-verified":
                a.result==="FLAGGED" ?"row-flagged":
                "row-rejected";

            return `
            <tr class="${cls}">
                <td>${new Date(a.attemptTime).toLocaleString()}</td>
                <td>${a.runnerId}</td>
                <td>${formatNumber(a.distanceKm,3)}</td>
                <td>${formatNumber(a.elevationGainM,1)}</td>
                <td>${pct!=null?formatNumber(pct,1)+"%":""}</td>
                <td>${formatNumber(a.maxDeviationM,1)}</td>
                <td>${formatNumber(a.difficultyScore,2)}</td>
                <td>${formatBadge(a.result)}</td>
                <td class="message-cell" title="${a.message}">${a.message}</td>
                <td>${a.id}</td>
                <!-- NEW: MAP BUTTON -->
                <td><button onclick="openMap(${a.id})">Map</button></td>
            </tr>`;
        }).join("");
    }

    // ---------------------------------------------------------------
    // LOAD DATA
    // ---------------------------------------------------------------
    async function loadAttempts(){
        const res = await fetch("/api/attempts");
        allAttempts = await res.json();
        applyFilters();
    }

    function applyFilters(){
        let list = allAttempts;
        let fR = filterRunner.value.toLowerCase();
        let fRes = filterResult.value.toUpperCase();

        if(fR) list = list.filter(a => (a.runnerId||"").toLowerCase().includes(fR));
        if(fRes) list = list.filter(a => a.result===fRes);

        renderAttempts(list);
    }

    filterRunner.oninput = applyFilters;
    filterResult.onchange = applyFilters;

    document.getElementById("refreshBtn").onclick = loadAttempts;

    // ---------------------------------------------------------------
    // UPLOAD
    // ---------------------------------------------------------------
    document.getElementById("uploadForm").onsubmit = async(e)=>{
        e.preventDefault();
        const f = new FormData();
        f.append("runnerId", runnerId.value);
        f.append("file", gpxFile.files[0]);
        await fetch("/api/attempts/upload", { method:"POST", body:f });
        loadAttempts();
    };

    loadAttempts();

    // ---------------------------------------------------------------
    // LEAFLET MAP HANDLING
    // ---------------------------------------------------------------
    let map = null;

    async function openMap(id){
        mapModal.style.display="flex";
        mapTitle.textContent = `GPX Viewer – Attempt #${id}`;

        if(!map){
            map = L.map("mapContainer");
            L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 18
            }).addTo(map);
        }

        const res = await fetch(`/api/attempts/${id}/track`);
        const pts = await res.json();

        if(!pts || pts.length===0){
            alert("No GPX track available.");
            return;
        }

        const latlngs = pts.map(p => [p.latitude, p.longitude]);

        // REMOVE existing layers first
        map.eachLayer(l=>{
            if(l instanceof L.Polyline || l instanceof L.Marker) map.removeLayer(l);
        });

        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        // Runner polyline
        const poly = L.polyline(latlngs, {color:"#38bdf8", weight:4});
        poly.addTo(map);
        map.fitBounds(poly.getBounds());

        // Optional: Fetch official route & overlay
        const routeRes = await fetch("/api/route/track").catch(()=>null);
        if(routeRes && routeRes.ok){
            const routePts = await routeRes.json();
            const routeLatLngs = routePts.map(p=>[p.latitude,p.longitude]);
            L.polyline(routeLatLngs,{color:"#4ade80",weight:3,opacity:0.7}).addTo(map);
        }
    }

    function closeMap(){
        mapModal.style.display="none";
    }
</script>

</body>
</html>
